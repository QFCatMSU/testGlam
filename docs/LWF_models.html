<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>web2 - Lake Whitefish Model Description</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://qfcatmsu.github.io/css/presStyle.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">web2</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./LWF_models.html" rel="" target="" aria-current="page">
 <span class="menu-text">LWF Models</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./R_functions.html" rel="" target="">
 <span class="menu-text">R Functions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./run_RTMB.html" rel="" target="">
 <span class="menu-text">Run RTMB</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lake-whitefish-statistical-catch-at-age-model" id="toc-lake-whitefish-statistical-catch-at-age-model" class="nav-link active" data-scroll-target="#lake-whitefish-statistical-catch-at-age-model">Lake Whitefish Statistical Catch at Age Model</a>
  <ul class="collapse">
  <li><a href="#symbols" id="toc-symbols" class="nav-link" data-scroll-target="#symbols">0. Symbols</a></li>
  <li><a href="#survey-data" id="toc-survey-data" class="nav-link" data-scroll-target="#survey-data">1. Survey data</a></li>
  <li><a href="#growth-weight-maturity-and-eggs" id="toc-growth-weight-maturity-and-eggs" class="nav-link" data-scroll-target="#growth-weight-maturity-and-eggs">2. Growth, weight, maturity, and eggs</a></li>
  <li><a href="#selectivity-and-catchability" id="toc-selectivity-and-catchability" class="nav-link" data-scroll-target="#selectivity-and-catchability">3. Selectivity and catchability</a>
  <ul class="collapse">
  <li><a href="#lognormal-selectivity" id="toc-lognormal-selectivity" class="nav-link" data-scroll-target="#lognormal-selectivity">3.1. Lognormal selectivity</a></li>
  <li><a href="#random-walk-catchability" id="toc-random-walk-catchability" class="nav-link" data-scroll-target="#random-walk-catchability">3.2. Random walk catchability</a></li>
  </ul></li>
  <li><a href="#mortalities" id="toc-mortalities" class="nav-link" data-scroll-target="#mortalities">4. Mortalities</a></li>
  <li><a href="#recruitment" id="toc-recruitment" class="nav-link" data-scroll-target="#recruitment">5. Recruitment</a>
  <ul class="collapse">
  <li><a href="#random-walk" id="toc-random-walk" class="nav-link" data-scroll-target="#random-walk">5. Random walk</a></li>
  </ul></li>
  <li><a href="#numbers-at-age" id="toc-numbers-at-age" class="nav-link" data-scroll-target="#numbers-at-age">6. Numbers at age</a></li>
  <li><a href="#time-dynamic-calculations" id="toc-time-dynamic-calculations" class="nav-link" data-scroll-target="#time-dynamic-calculations">7. Time-dynamic calculations</a></li>
  <li><a href="#likelihoods" id="toc-likelihoods" class="nav-link" data-scroll-target="#likelihoods">8. Likelihoods</a>
  <ul class="collapse">
  <li><a href="#natural-mortality" id="toc-natural-mortality" class="nav-link" data-scroll-target="#natural-mortality">8.1 Natural mortality</a></li>
  <li><a href="#age-composition" id="toc-age-composition" class="nav-link" data-scroll-target="#age-composition">8. Age composition</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lake Whitefish Model Description</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="lake-whitefish-statistical-catch-at-age-model" class="level1">
<h1>Lake Whitefish Statistical Catch at Age Model</h1>
<p>Adopted text from <a href="https://www.canr.msu.edu/qfc/publications/pdf-techreports/2016-techreports/T2016-01.pdf">Truesdell and Bence 2016</a>.</p>
<p>This reviews the model design for the stock assessment models for lake whitefish in 1836 Treaty Waters. [Section descriptions].</p>
<section id="symbols" class="level2">
<h2 class="anchored" data-anchor-id="symbols">0. Symbols</h2>
<table class="table">
<thead>
<tr class="header">
<th>Name</th>
<th>Description</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(y\)</span></td>
<td>Years of stock asssessment</td>
<td>1985-2022</td>
</tr>
<tr class="even">
<td><span class="math inline">\(A\)</span></td>
<td>Max age (plus age)</td>
<td>20</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(a^R\)</span></td>
<td>Age at recruitment</td>
<td>3</td>
</tr>
<tr class="even">
<td><span class="math inline">\(sp\)</span></td>
<td>Spawning time</td>
<td>0.838</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(sv\)</span></td>
<td>Survey time</td>
<td>0.5</td>
</tr>
</tbody>
</table>
</section>
<section id="survey-data" class="level2">
<h2 class="anchored" data-anchor-id="survey-data">1. Survey data</h2>
<p>Adjustments to effort and catch <span class="math display">\[
C^{trap}_y = \dfrac{B^{trap}_y / CW^{trap}_y}{\tau^{C_{trap}}}
\]</span> <span class="math display">\[
C^{gill}_y = \dfrac{B^{gill}_y / CW^{gill}_y}{\tau^{C_{gill}}}
\]</span> where <span class="math inline">\(\tau^{C_{trap}}\)</span> and <span class="math inline">\(\tau^{C_{gill}}\)</span> are the harvest adjustment for under reporting for trap and gillnet, respectively.</p>
<p><span class="math display">\[
E^{gill} = E^{gill} * \tau^{E_{gill}}
\]</span> where <span class="math inline">\(\tau^{E_{gill}}\)</span> is the adjustment in effort for changes over time.</p>
</section>
<section id="growth-weight-maturity-and-eggs" class="level2">
<h2 class="anchored" data-anchor-id="growth-weight-maturity-and-eggs">2. Growth, weight, maturity, and eggs</h2>
<p>Weight-at-age the time of spawning was calculated from input weight-at-age observed in spring gill-net surveys, assuming exponential growth from the time of the survey until the time of spawning:</p>
<p><span class="math display">\[
\begin{array}{l}
G_{y, a}=\ln \left(\frac{W^{survey}_{y+1, a+1}}{W^{survey}_{y,a}}\right) \\
W^{pop}_{y, a} = W^{survey}_{y, a+1}*e^{-0.5 G_{y-1, a-1}} \\
W^{spawn}_{y, a}= W^{survey}_{y, a+1} * e^{(sp - 0.5) * G_{y, a + 1}}
\end{array}
\]</span></p>
</section>
<section id="selectivity-and-catchability" class="level2">
<h2 class="anchored" data-anchor-id="selectivity-and-catchability">3. Selectivity and catchability</h2>
<p>This section describes the various functions for selectivity and catchaility (not affiliated with a specific fishery).</p>
<section id="lognormal-selectivity" class="level3">
<h3 class="anchored" data-anchor-id="lognormal-selectivity">3.1. Lognormal selectivity</h3>
<p>This estimates selectivity at age using length-at-age. Non tandardized selectivity <span class="math inline">\(S^{*}\)</span> is:</p>
<p><span class="math display">\[
S_{y, a}^{*}=\frac{1}{\sigma_{y} L_{y, a} \sqrt{2 \pi}} e^{-\frac{(ln(L_{y, a})-\mu^{2})}{2 {\sigma_{y}^{S}}^{2}}}
\]</span></p>
<p>where <span class="math inline">\({\sigma_{y}^{S}}^{2}\)</span> is the lognormal standard deviation for selectivity, <span class="math inline">\(L_{y,a}\)</span> is the length at age, and <span class="math inline">\(\mu\)</span> is the lognormal mean (one of the estimated selectivity parameters). The selectivity is standardized by the lognormal probability distribution function at a length equal to <span class="math inline">\(\mu\)</span>:</p>
<p><span class="math display">\[
S^{\mu}_y = \dfrac{1}{\sigma^{S}_y e^{\mu} \sqrt{2 \pi}}
\]</span></p>
<p>The standardized selectivity is then: <span class="math display">\[
\begin{equation}
\tag{3.1.X}
S_{y,a} = \dfrac{S^{*}_{y,a}}{S^{\mu}_y}
\label{eq:3.1.X}
\end{equation}
\]</span></p>
<p>The selectivity in most years is time-varying with respect to the parameter <span class="math inline">\(\sigma^{S}_y\)</span>, which is freely estimated each year:</p>
<p><span class="math display">\[
\sigma_{y}^{S}=\left\{\begin{array}{ll}
e^{\kappa_{y}} &amp; \text { if } y=1 \\
e^{ln \left(\sigma_{y-1}^{S}\right)+\kappa_{y}} &amp; \text { if } y&gt;1
\end{array}\right.
\]</span> where <span class="math inline">\(\kappa_y\)</span> is freely estimated and a log-scale deviation <span class="math inline">\(\kappa\)</span> is estimated for each year.</p>
<p>Note that <span class="math inline">\(\eqref{eq:3.1.X}\)</span> is maximized at <span class="math inline">\(exp(\mu - \dfrac{{\sigma^{S}}^2}{2})\)</span> so selectivity at age can exceed 1.</p>
</section>
<section id="random-walk-catchability" class="level3">
<h3 class="anchored" data-anchor-id="random-walk-catchability">3.2. Random walk catchability</h3>
<p><span class="math display">\[
q_{y}=\left\{\begin{array}{ll}
e^{ln(q_{y})} &amp; \text { if } y=1 \\
e^{ln(q_{y-1}) + ln(\sigma^q_y)} &amp; \text { if } y&gt;1
\end{array}\right.
\]</span> where <span class="math inline">\(\sigma^q_y\)</span> is the log scale catchability deviation.</p>
</section>
</section>
<section id="mortalities" class="level2">
<h2 class="anchored" data-anchor-id="mortalities">4. Mortalities</h2>
<p>The total instantaneous mortality is the sum of fishing mortality and natural mortality.</p>
<p><span class="math display">\[
Z_{y,a} = F^{gill}_{y,a} + F^{trap}_{y,a} + M + M^L_{y,a}
\]</span> where <span class="math inline">\(F^{gill}_{y,a}\)</span> represents fishing mortality from gillnet, <span class="math inline">\(F^{trap}_{y,a}\)</span> represents fishing mortlaity from trapnet, <span class="math inline">\(M\)</span> is natural mortality, and <span class="math inline">\(M^L_{y,a}\)</span> is sea lamprey-induced natural mortality. The sea lamprey mortality rate were estimated externally to the stock assessment model.</p>
<p>Values for natural mortality (<span class="math inline">\(M\)</span>) were fitted during the modeling process with a prior derived from Pauly’s generalized equation that uses the von Bertalanffy growth parameters (<span class="math inline">\(L_\infty\)</span> and <span class="math inline">\(k\)</span>), and annual mean water temperature (<span class="math inline">\(T\)</span>) as described by Pauly (1980):</p>
<p><span class="math display">\[
ln(\hat{M}) = -0.0238-0.277 L_\infty + 0.655 ln(k) + 0.465 ln(T)
\]</span> with length measured in mm and temperature in <span class="math inline">\(^\circ\)</span>C. Deviations from this prior were penalized during model fitting (see <a href="#likelihoods">Likelihoods</a> section).</p>
</section>
<section id="recruitment" class="level2">
<h2 class="anchored" data-anchor-id="recruitment">5. Recruitment</h2>
<section id="random-walk" class="level3">
<h3 class="anchored" data-anchor-id="random-walk">5. Random walk</h3>
<p><span class="math display">\[
ln(R_y) = ln(R_{y-1}) + \psi_y
\]</span> with <span class="math inline">\(ln(R_{y_0})\)</span> and the <span class="math inline">\(\psi_y\)</span> estimated as parameters. <span class="math inline">\(\psi_y\)</span> is a vector of deviations that describes how much log recruitment changed each year from the amount in the previous year (i.e., recruitment deviations). Using a random walk assumes correlation in year-to-year recruitment because the most likely value for <span class="math inline">\(psi\)</span> is zero (Caroffino and Lenart, 2011), and thus large changes from year to year are penalized (see <a href="#likelihoods">Likelihoods</a> section).</p>
</section>
</section>
<section id="numbers-at-age" class="level2">
<h2 class="anchored" data-anchor-id="numbers-at-age">6. Numbers at age</h2>
<p>The abundance-at-age at the start of each year is calculated recursively as the proportion of the cohort surviving (<span class="math inline">\(e^{-Z}\)</span>) from the start of the previous year.</p>
<p><span class="math display">\[
N_{y,a}=\left\{\begin{array}{cc}R_y &amp; a^R \\N_{y-1, a-1} e^{-Z_{y-1, a-1}} &amp; a^R&lt;a&lt;A \\N_{y-1, a-1} e^{-Z_{y-1, a-1}} + N_{y-1, a} e^{Z_{y-1, a}} &amp; a=A \\\end{array}\right.
\]</span></p>
<p>where <span class="math inline">\(R_y\)</span> is recruitment per time step and <span class="math inline">\(Z_{y,a}\)</span> is the total instantaneous mortality rate.</p>
</section>
<section id="time-dynamic-calculations" class="level2">
<h2 class="anchored" data-anchor-id="time-dynamic-calculations">7. Time-dynamic calculations</h2>
<p>Catch-at-age for each fishery is estimated using Baranov’s equation: <span class="math display">\[
C_{a, y}=\frac{F_{a, y}}{Z_{a, y}} N_{a, y}\left(1-e^{-Z_{a, y}}\right)
\]</span> where <span class="math inline">\(C_{a, y}\)</span> is the catch-at-age. The models treated the total catch each year and the proportions of catch-at-age for each year as separate data sources.</p>
</section>
<section id="likelihoods" class="level2">
<h2 class="anchored" data-anchor-id="likelihoods">8. Likelihoods</h2>
<p>The parameters in the models were adjusted during fitting so that they minimized an objective function. The objective function was: <span class="math display">\[
-L=\sum_{i=1}^{k}-\rho_{i} L_{i}
\]</span> where <span class="math inline">\(k\)</span> is the number of components in the likelihood functions, <span class="math inline">\(\rho_i\)</span> is the weighting of component <span class="math inline">\(i\)</span>, and <span class="math inline">\(L_i\)</span> was either the log-likelihood of data component <span class="math inline">\(i\)</span> given specific parameter values or log prior densities for paraemters. The weights were defined prior to model fit for each component (<span class="math inline">\(\rho\)</span>). Different error distributions can be assumed for each of the likelihood components. This approach to estimation (fixing variances or ratio of variances and using point estimates obtained by minimizing the total likelihood) is known as “error in variables”, “penalized likelihood”, or “highest posterior density estimation” (Schnute, 1994; Wilberg et al, 2010).</p>
<section id="natural-mortality" class="level3">
<h3 class="anchored" data-anchor-id="natural-mortality">8.1 Natural mortality</h3>
<p>The standard deviation for the prior distribtuion was fixed at a single value for whitefish models.</p>
</section>
<section id="age-composition" class="level3">
<h3 class="anchored" data-anchor-id="age-composition">8. Age composition</h3>
<p>Age composition <span class="math display">\[
L_{i}=\sum_{y} n_{i, y}^{*} \sum_{a} p_{i, a, y} \ln \left(\hat{p}_{i, a, y}\right)
\]</span> where <span class="math inline">\(n_{i, y}^{*}\)</span> are the effective sample sizes, <span class="math inline">\(p_{i, a, y}\)</span> are the observed proportions and <span class="math inline">\(\hat{p}_{i, a, y}\)</span> are the estimated proportions.</p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>